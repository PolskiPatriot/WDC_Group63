<!DOCTYPE html>
<html lang="en">

<head>
    <title>untitled - Login</title>
    <link rel="stylesheet" href="/stylesheets/header.css">
    <link rel="stylesheet" href="/stylesheets/10.css">
    <script src="https://accounts.google.com/gsi/client" async></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
</head>

<body id="content">
    <iframe class="headerIframe" title="header" name="header" id="header" src="header.html" width="100%"
        height="120px"></iframe>
    <iframe class="headerIframe" title="dropdown" name="dropdown" id="dropdown" src="dropdown.html" width="315px"
        height="460px"></iframe>
    <div class="row">
        <div class="column" id="leftColumn"></div>
        <div class="column" id="middleColumn">
            <h1>Login</h1>
            <div class="textInputs">
                <input type="text" class="barInput" placeholder="Email" id="email" />
                <input type="password" class="barInput" placeholder="Password" id="password" />
            </div>
            <div class="loginButtons">
                <button type="button" class="inputLogin" onclick="login()">LOG IN</button>
                <a href="/11.html" id="forgotPassword">Forgot Password</a>
            </div>
            <div class="textInputs">
                <div id="g_id_onload"
                    data-client_id="119246077266-568pi1sojct64fdrvn10enalph5aqgg3.apps.googleusercontent.com"
                    data-context="signin"
                    data-ux_mode="popup"
                    data-callback="google_callback"
                    data-itp_support="true">
                </div>
                <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="filled_blue"
                data-text="signin_with"
                data-size="large"
                data-logo_alignment="left">
                </div>
            </div>
            <div id="signUpLink">New to "untitled"? <a href="/13.html">Sign up</a></div>
        </div>
        <div class="column" id="rightColumn"></div>
    </div>

    <script>
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            fetch('/Signin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Login successful');
                        if (data.success) {
                            history.back();
                        }
                    } else {
                        alert('Login failed: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('There was an error!', error);
                });
        }

        function google_callback(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            console.log("ID: " + responsePayload.sub);
            console.log('Full Name: ' + responsePayload.name);
            console.log('Given Name: ' + responsePayload.given_name);
            console.log('Family Name: ' + responsePayload.family_name);
            console.log("Email: " + responsePayload.email);
            fetch('/Signin/google-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: response.credential
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Login successful');
                        window.location.replace('/');
                    } else {
                        alert('Login failed: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error("There was an error", error);
                });
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>